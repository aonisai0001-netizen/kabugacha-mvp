<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="æ ªã‚¬ãƒãƒ£æœªæ¥äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§ç±³å›½æ ªã®æœªæ¥ãƒªã‚¿ãƒ¼ãƒ³ã‚’ã‚¬ãƒãƒ£å½¢å¼ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ãƒ¬ã‚¢åº¦åˆ¤å®šã§æ¥½ã—ãæŠ•è³‡å­¦ç¿’ã€‚" />
  
  <!-- OGP -->
  <meta property="og:title" content="æ ªã‚¬ãƒãƒ£æœªæ¥äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼" />
  <meta property="og:description" content="ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§æ ªã®æœªæ¥ãƒªã‚¿ãƒ¼ãƒ³ã‚’ã‚¬ãƒãƒ£å½¢å¼ã§å ã†æ–°æ„Ÿè¦šæŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kabugacha-mvp.vercel.app/" />
  <meta property="og:image" content="https://kabugacha-mvp.vercel.app/ogp.png" />
  
  <title>æ ªã‚¬ãƒãƒ£æœªæ¥äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ MVP</title>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4916512793291121"
     crossorigin="anonymous"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8T8EFWZ2NY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8T8EFWZ2NY');
  </script>

  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#12172a;
      --panel-2:#0f1324;
      --text:#e6e9f2;
      --muted:#9aa3b2;
      --accent:#7c5cff;
      --good:#32d583;
      --warn:#f79009;
      --bad:#ff6b6b;
      --gold:#ffd166;
      --pink:#ff7ab6;
      --cyan:#67e8f9;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; background:radial-gradient(1200px 600px at 50% -10%, #1e2440, var(--bg));
      color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      min-height:100vh; display:flex; justify-content:center; padding:16px;
    }
    .wrap{width:min(980px, 100%); display:grid; gap:12px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; background:linear-gradient(180deg, #151b33, #0e1224);
      border:1px solid rgba(255,255,255,.06); border-radius:14px;
      position:sticky; top:0; z-index:5; backdrop-filter: blur(6px);
    }
    header .title{font-weight:800; letter-spacing:.02em;}
    header .sub{font-size:12px; color:var(--muted);}
    
    .intro{
      background:var(--panel); border:1px solid rgba(255,255,255,.06); 
      border-radius:14px; padding:20px; line-height:1.7;
    }
    .intro h2{margin-top:0; margin-bottom:12px; color:var(--accent); font-size:20px;}
    .intro h3{margin-top:16px; margin-bottom:8px; color:var(--cyan); font-size:16px;}
    .intro ul{margin:10px 0; padding-left:20px;}
    .intro li{margin:6px 0;}
    .intro p{margin:10px 0;}
    
    .about-section{
      background:var(--panel-2); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:18px; margin-top:16px;
      border-left:3px solid var(--accent);
    }
    
    .controls{
      display:grid; grid-template-columns: 1fr 1fr; gap:8px;
      background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px;
    }
    .control{
      background:var(--panel-2); border:1px solid rgba(255,255,255,.06);
      padding:10px; border-radius:12px; display:grid; gap:6px;
    }
    label{font-size:12px; color:var(--muted);}
    select, button{
      width:100%; font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#0b1022; color:var(--text);
      outline:none;
    }
    button{cursor:pointer;}
    .gacha-area{
      background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:18px;
      padding:16px; display:grid; gap:12px; position:relative; overflow:hidden;
    }
    .roll-btn{
      font-size:20px; font-weight:800; padding:16px;
      background:linear-gradient(135deg, #7c5cff, #34d399);
      border:none; box-shadow:0 8px 22px rgba(124,92,255,.35);
      transition:transform .06s ease, filter .2s ease;
    }
    .roll-btn:active{transform:translateY(2px) scale(0.98);}
    .result{
      background:#0a0f20; border:1px dashed rgba(255,255,255,.12); border-radius:14px;
      padding:14px; display:grid; gap:8px; min-height:160px;
    }
    .row{display:flex; justify-content:space-between; gap:8px;}
    .k{color:var(--muted); font-size:13px;}
    .v{font-weight:700;}
    .rarity-badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:900; letter-spacing:.06em;
      border:1px solid rgba(255,255,255,.18);
      text-shadow:0 0 8px rgba(255,255,255,.35);
    }
    .R{background:rgba(154,163,178,.12); color:#c8ceda;}
    .SR{background:rgba(103,232,249,.12); color:var(--cyan);}
    .SSR{background:rgba(255,209,102,.12); color:var(--gold);}
    .SSRp{background:rgba(255,122,182,.12); color:var(--pink);}
    .SSRpp{background:rgba(124,92,255,.16); color:#c4b5fd;}
    .big{
      font-size:22px; font-weight:900;
    }
    .pos{color:var(--good);}
    .neg{color:var(--bad);}
    .share{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;
    }
    .share button{
      background:#0b1022; border:1px solid rgba(255,255,255,.12); font-weight:700;
    }
    .history{
      background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px;
      display:grid; gap:8px;
    }
    .history .item{
      background:var(--panel-2); border:1px solid rgba(255,255,255,.06);
      padding:8px 10px; border-radius:10px; display:flex; justify-content:space-between; gap:8px; font-size:13px;
      align-items:center;
    }
    .ads{
      background:#0a0f20; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px;
      color:var(--muted); font-size:12px; text-align:center; min-height:90px;
      display:flex; align-items:center; justify-content:center;
    }
    .ads strong{color:#d1d5db;}
    .note{
      font-size:12px; color:var(--muted); line-height:1.6;
      background:transparent; padding:0 4px;
    }
    .confetti{
      position:absolute; inset:-20% -10% auto -10%; height:140%;
      pointer-events:none; opacity:0; transition:opacity .2s ease;
      background:
        radial-gradient(6px 10px at 10% 10%, #fff 40%, transparent 41%),
        radial-gradient(6px 10px at 30% 20%, #67e8f9 40%, transparent 41%),
        radial-gradient(6px 10px at 60% 30%, #ffd166 40%, transparent 41%),
        radial-gradient(6px 10px at 80% 10%, #ff7ab6 40%, transparent 41%),
        radial-gradient(6px 10px at 20% 60%, #a78bfa 40%, transparent 41%),
        radial-gradient(6px 10px at 70% 70%, #34d399 40%, transparent 41%);
      animation: fall 1.6s linear infinite;
      mix-blend-mode: screen;
    }
    .confetti.show{opacity:.9;}
    @keyframes fall{
      0%{transform:translateY(-10%) rotate(0deg);}
      100%{transform:translateY(10%) rotate(10deg);}
    }
    
    .footer-links{
      background:var(--panel-2); padding:12px; border-radius:10px;
      text-align:center; font-size:13px;
    }
    .footer-links a{
      color:var(--accent); text-decoration:none; margin:0 10px;
    }
    .footer-links a:hover{text-decoration:underline;}

    @media (max-width:720px){
      .controls{grid-template-columns:1fr;}
      .share{grid-template-columns:1fr;}
      header{position:static;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">æ ªã‚¬ãƒãƒ£ æœªæ¥äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
        <div class="sub">ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§é‹è©¦ã— â†’ æœªæ¥æ ªä¾¡ã¨ãƒ¬ã‚¢åº¦ãŒå‡ºã‚‹MVP</div>
      </div>
      <div class="sub" id="rollCount">ç·ã‚¬ãƒãƒ£å›æ•°: 0</div>
    </header>

    <!-- ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="intro">
      <h2>ğŸ“Š æ ªã‚¬ãƒãƒ£ã¨ã¯ï¼Ÿ</h2>
      <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ç±³å›½æ ªã®æœªæ¥ãƒªã‚¿ãƒ¼ãƒ³ã‚’ã‚¬ãƒãƒ£å½¢å¼ã§æ¥½ã—ãå­¦ã¹ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚</p>
      <ul>
        <li><strong>ãƒ¬ã‚¢åº¦åˆ¤å®šï¼š</strong> Rã€SRã€SSRã€SSR+ã€SSR++ ã®5æ®µéšã§ãƒªã‚¿ãƒ¼ãƒ³ã‚’è©•ä¾¡</li>
        <li><strong>3ã¤ã®ã‚·ãƒŠãƒªã‚ªï¼š</strong> æ¥½è¦³ãƒ»ç¾å®Ÿãƒ»æ‚²è¦³ã§ç•°ãªã‚‹æœªæ¥ã‚’æƒ³å®š</li>
        <li><strong>10éŠ˜æŸ„å¯¾å¿œï¼š</strong> AAPLã€MSFTã€NVDAã€TSLAãªã©äººæ°—éŠ˜æŸ„ã‚’åéŒ²</li>
      </ul>

      <div class="about-section">
        <h3>ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</h3>
        <p>
          å½“ã‚µã‚¤ãƒˆã¯ã€æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®éå»æ¨ç§»ã¨ä»®å®šã‚·ãƒŠãƒªã‚ªã‚’ã‚‚ã¨ã«ã€å°†æ¥ã®æ ªä¾¡ãƒ¬ãƒ³ã‚¸ã‚’ç°¡æ˜“çš„ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
          æŠ•è³‡åŠ©è¨€ã«ã¯è©²å½“ã›ãšã€è¨ˆç®—çµæœã¯äºˆæ¸¬ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>
        <h3>ä½¿ã„æ–¹</h3>
        <ul>
          <li>â‘  æ™‚é–“è»¸ã‚’é¸ã¶ï¼ˆ1å¹´ãƒ»3å¹´ãƒ»5å¹´ãƒ»10å¹´ï¼‰</li>
          <li>â‘¡ ã‚·ãƒŠãƒªã‚ªï¼ˆæ¥½è¦³ / ç¾å®Ÿ / æ‚²è¦³ï¼‰ã‚’é¸ã¶</li>
          <li>â‘¢ ã€Œã‚¬ãƒãƒ£ã‚’å›ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
        </ul>
      </div>

      <p class="note" style="margin-top:12px;">â€» æœ¬ãƒ„ãƒ¼ãƒ«ã¯å¨¯æ¥½ãƒ»å­¦ç¿’ç›®çš„ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®æŠ•è³‡åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚</p>
    </section>

    <!-- åºƒå‘Šæ ï¼ˆä¸Šï¼‰ -->
    <div class="ads">
      <strong>åºƒå‘Šæ ï¼ˆAdSenseå¯©æŸ»ä¸­ï¼‰</strong>
    </div>

    <section class="controls">
      <div class="control">
        <label>æ™‚é–“è»¸</label>
        <select id="years">
          <option value="1">1å¹´</option>
          <option value="3">3å¹´</option>
          <option value="5">5å¹´</option>
          <option value="10" selected>10å¹´</option>
        </select>
      </div>
      <div class="control">
        <label>ã‚·ãƒŠãƒªã‚ª</label>
        <select id="scenario">
          <option value="optimistic">æ¥½è¦³</option>
          <option value="realistic" selected>ç¾å®Ÿ</option>
          <option value="pessimistic">æ‚²è¦³</option>
        </select>
      </div>
    </section>

    <section class="gacha-area">
      <div class="confetti" id="confetti"></div>

      <button class="roll-btn" id="rollBtn">ã‚¬ãƒãƒ£ã‚’å›ã™</button>

      <div class="result" id="result">
        <div class="note">ã€Œå›ã™ã€ã‚’æŠ¼ã™ã¨ã€éŠ˜æŸ„ãƒ»æœªæ¥ä¾¡æ ¼ãƒ»CAGRãƒ»ãƒ¬ã‚¢åº¦ãŒä¸€ç™ºã§å‡ºã¾ã™ã€‚</div>
      </div>

      <div class="share">
        <button id="shareX">Xã§ã‚·ã‚§ã‚¢</button>
        <button id="shareLine">LINEã§ã‚·ã‚§ã‚¢</button>
        <button id="copyText">çµæœæ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="note" id="hint">
        SSR+ ä»¥ä¸ŠãŒå‡ºãŸã‚‰ã‚¹ã‚¯ã‚·ãƒ§æ¨å¥¨ã€‚ä½•å›ã§ã‚‚å›ã›ã¾ã™ã€‚
      </div>
    </section>

    <section class="history">
      <div class="title" style="font-weight:800;">ç›´è¿‘ã®å±¥æ­´ï¼ˆæœ€å¤§10ä»¶ï¼‰</div>
      <div id="historyList"></div>
    </section>

    <!-- åºƒå‘Šæ ï¼ˆä¸‹ï¼‰ -->
    <div class="ads">
      <strong>åºƒå‘Šæ ï¼ˆAdSenseå¯©æŸ»ä¸­ï¼‰</strong>
    </div>

    <div class="footer-links">
      <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> / 
      <a href="disclaimer.html">å…è²¬äº‹é …</a>
    </div>
  </div>

<script>
(() => {
  const TICKERS = [
    {symbol:"AAPL", name:"Apple", base:190},
    {symbol:"MSFT", name:"Microsoft", base:420},
    {symbol:"AMZN", name:"Amazon", base:170},
    {symbol:"NVDA", name:"NVIDIA", base:140},
    {symbol:"TSLA", name:"Tesla", base:250},
    {symbol:"GOOG", name:"Alphabet", base:175},
    {symbol:"META", name:"Meta", base:500},
    {symbol:"V", name:"Visa", base:280},
    {symbol:"JPM", name:"JPMorgan", base:210},
    {symbol:"KO", name:"Coca-Cola", base:60},
  ];

  const RARITIES = [
    {key:"R",     label:"R",     prob:0.70, min:-10,  max:20,  cls:"R"},
    {key:"SR",    label:"SR",    prob:0.20, min:20,   max:100, cls:"SR"},
    {key:"SSR",   label:"SSR",   prob:0.08, min:100,  max:300, cls:"SSR"},
    {key:"SSR+",  label:"SSR+",  prob:0.015,min:300,  max:1000,cls:"SSRp"},
    {key:"SSR++", label:"SSR++", prob:0.005,min:1000, max:1600,cls:"SSRpp"}
  ];

  const INVEST_YEN = 1_000_000;

  const yearsEl = document.getElementById("years");
  const scenarioEl = document.getElementById("scenario");
  const rollBtn = document.getElementById("rollBtn");
  const resultEl = document.getElementById("result");
  const historyListEl = document.getElementById("historyList");
  const rollCountEl = document.getElementById("rollCount");
  const confettiEl = document.getElementById("confetti");

  const shareXBtn = document.getElementById("shareX");
  const shareLineBtn = document.getElementById("shareLine");
  const copyTextBtn = document.getElementById("copyText");

  let lastShareText = "";
  let rollCount = Number(localStorage.getItem("rollCount") || 0);

  const pick = arr => arr[Math.floor(Math.random() * arr.length)];

  function rollRarity(){
    const r = Math.random();
    let acc = 0;
    for(const it of RARITIES){
      acc += it.prob;
      if(r <= acc) return it;
    }
    return RARITIES[0];
  }

  function skewU(u, scenario){
    if(scenario === "optimistic") return Math.sqrt(u);
    if(scenario === "pessimistic") return u*u;
    return u;
  }

  function formatPct(x){
    const sign = x >= 0 ? "+" : "";
    return sign + x.toFixed(1) + "%";
  }
  function formatNum(x){
    return x.toLocaleString("ja-JP");
  }

  function calcCAGR(totalReturnPct, years){
    const m = 1 + totalReturnPct/100;
    return (Math.pow(m, 1/years) - 1) * 100;
  }

  function flashByRarity(rarityKey){
    confettiEl.classList.remove("show");
    if(rarityKey === "SSR+" || rarityKey === "SSR++"){
      confettiEl.classList.add("show");
      setTimeout(()=>confettiEl.classList.remove("show"), 1400);
    }
  }

  function loadHistory(){
    try{
      return JSON.parse(localStorage.getItem("history") || "[]");
    }catch{ return []; }
  }
  function saveHistory(h){
    localStorage.setItem("history", JSON.stringify(h.slice(0,10)));
  }
  function renderHistory(){
    const h = loadHistory();
    historyListEl.innerHTML = "";
    if(!h.length){
      historyListEl.innerHTML = `<div class="note">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }
    for(const item of h){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <strong>${item.rarity}</strong> ${item.symbol}
          <span style="color:var(--muted)">(${item.years}å¹´/${item.scenarioJP})</span>
        </div>
        <div class="${item.totalReturnPct>=0?'pos':'neg'}">${formatPct(item.totalReturnPct)}</div>
      `;
      historyListEl.appendChild(div);
    }
  }

  function rollOnce(){
    const years = Number(yearsEl.value);
    const scenario = scenarioEl.value;
    const scenarioJP = scenario==="optimistic" ? "æ¥½è¦³" : scenario==="pessimistic" ? "æ‚²è¦³" : "ç¾å®Ÿ";

    const ticker = pick(TICKERS);
    const rarity = rollRarity();

    let u = Math.random();
    u = skewU(u, scenario);
    let totalReturnPct = rarity.min + u*(rarity.max - rarity.min);

    const basePrice = ticker.base;
    const futurePrice = basePrice*(1 + totalReturnPct/100);
    const cagrPct = calcCAGR(totalReturnPct, years);
    const investFutureYen = INVEST_YEN*(1 + totalReturnPct/100);

    resultEl.innerHTML = `
      <div class="row">
        <div class="k">éŠ˜æŸ„</div>
        <div class="v big">${ticker.symbol} <span style="font-size:12px;color:var(--muted);font-weight:600;">${ticker.name}</span></div>
      </div>
      <div class="row">
        <div class="k">æ™‚é–“è»¸ / ã‚·ãƒŠãƒªã‚ª</div>
        <div class="v">${years}å¹´ / ${scenarioJP}</div>
      </div>
      <div class="row">
        <div class="k">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</div>
        <div class="v">
          <span class="rarity-badge ${rarity.cls}">${rarity.label}</span>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.06)"/>

      <div class="row">
        <div class="k">æƒ³å®šç¾åœ¨æ ªä¾¡ï¼ˆä»®ï¼‰</div>
        <div class="v">$${basePrice.toFixed(2)}</div>
      </div>
      <div class="row">
        <div class="k">æƒ³å®šæœªæ¥æ ªä¾¡</div>
        <div class="v">$${futurePrice.toFixed(2)}</div>
      </div>
      <div class="row">
        <div class="k">ãƒˆãƒ¼ã‚¿ãƒ«ãƒªã‚¿ãƒ¼ãƒ³</div>
        <div class="v ${totalReturnPct>=0?'pos':'neg'}">${formatPct(totalReturnPct)}</div>
      </div>
      <div class="row">
        <div class="k">CAGRï¼ˆå¹´å¹³å‡ï¼‰</div>
        <div class="v ${cagrPct>=0?'pos':'neg'}">${formatPct(cagrPct)}</div>
      </div>
      <div class="row">
        <div class="k">æŠ•è³‡100ä¸‡å††ã®æœªæ¥ä¾¡å€¤</div>
        <div class="v">${formatNum(Math.round(investFutureYen))} å††</div>
      </div>

      <div class="note" style="margin-top:6px;">
        â€» ãƒ¬ã‚¢ç¢ºç‡ã«åŸºã¥ã"é‹è©¦ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"ã€‚ç¾å®Ÿã®æ ªä¾¡ã¨ã¯ç„¡é–¢ä¿‚ã§ã™ã€‚
      </div>
    `;

    flashByRarity(rarity.key);

    lastShareText = [
      `ã€æ ªã‚¬ãƒãƒ£çµæœã€‘`,
      `${ticker.symbol} / ${years}å¹´ / ${scenarioJP}`,
      `ãƒ¬ã‚¢: ${rarity.label}`,
      `æœªæ¥ãƒªã‚¿ãƒ¼ãƒ³: ${formatPct(totalReturnPct)}`,
      `CAGR: ${formatPct(cagrPct)}`,
      `æŠ•è³‡100ä¸‡â†’ ${formatNum(Math.round(investFutureYen))}å††`,
      `#æ ªã‚¬ãƒãƒ£ #æœªæ¥äºˆæ¸¬ #æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`
    ].join("\n");

    const h = loadHistory();
    h.unshift({
      symbol:ticker.symbol,
      years, scenarioJP,
      rarity:rarity.label,
      totalReturnPct
    });
    saveHistory(h);
    renderHistory();

    rollCount++;
    localStorage.setItem("rollCount", rollCount);
    rollCountEl.textContent = `ç·ã‚¬ãƒãƒ£å›æ•°: ${rollCount}`;

    if(typeof gtag !== 'undefined'){
      gtag('event', 'gacha_roll', {
        'ticker': ticker.symbol,
        'years': years,
        'scenario': scenarioJP,
        'rarity': rarity.label,
        'return_pct': totalReturnPct.toFixed(1)
      });
    }

    rollBtn.disabled = true;
    setTimeout(()=>rollBtn.disabled=false, 350);
  }

  function shareX(){
    if(!lastShareText) return;
    const url = encodeURIComponent(location.href);
    const text = encodeURIComponent(lastShareText);
    const intent = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
    window.open(intent, "_blank");
  }

  function shareLine(){
    if(!lastShareText) return;
    const url = encodeURIComponent(location.href);
    const text = encodeURIComponent(lastShareText);
    const line = `https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`;
    window.open(line, "_blank");
  }

  async function copyText(){
    if(!lastShareText) return;
    try{
      await navigator.clipboard.writeText(lastShareText);
      copyTextBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
      setTimeout(()=>copyTextBtn.textContent="çµæœæ–‡ã‚’ã‚³ãƒ”ãƒ¼", 1200);
    }catch{
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }
  }

  rollBtn.addEventListener("click", rollOnce);
  shareXBtn.addEventListener("click", shareX);
  shareLineBtn.addEventListener("click", shareLine);
  copyTextBtn.addEventListener("click", copyText);

  rollCountEl.textContent = `ç·ã‚¬ãƒãƒ£å›æ•°: ${rollCount}`;
  renderHistory();
})();
</script>

</body>
</html>
